
<!DOCTYPE html>

<html> 

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<title>lukencode | code first, ask questions later</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="/img/favicon.ico">

	<link rel="profile" href="http://gmpg.org/xfn/11" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/responsive.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/prettify.css" type="text/css" media="screen, projection" />
	<link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
	
	<!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
	
	<script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
	
	<script src="/js/prettify.js" type="text/javascript"></script>
	
	<meta name="google-site-verification" content="e6fQUO7vqSIw6sdQQeiUPs4JPc8VghE_9u72V2NXv4U" /> 	
</head>		
	
<body onload="prettyPrint()">
	<div id="header-wrap">
		<header>
			<hgroup>
				<h1>
					<a href="/" title="lukencode" rel="home"></a>
				</h1>
				<div id="site-description">code first, ask questions later</div>
			</hgroup>			
		</header>
								
		<div id="secondary" class="widget-area">
			<aside id="me" class="widget">
				<div class="info">
					<h4>Author</h4>	
					
					<img class="grav" src='http://en.gravatar.com/userimage/7397984/5de7392594b98c6b510f0691ca5e0638.jpeg' />
					
					<div class="about">
						<strong>Luke Lowrey</strong>
						<p>I drink beer and build web and mobile apps (in that order).</p>
					</div>
				</div>
				<div class="short-info">
					A programming blog by <strong>Luke Lowrey</strong>
				</div>
				<ul>
					<li id="twitter-button"><a href="http://twitter.com/lukencode" class="twitter-follow-button" data-button="grey" data-text-color="#FFFFFF" data-link-color="#00AEFF">Follow @lukencode</a></li>
					<li> <a href='/about'>About</a> </li>					
					<li> <a href='/contact'>Contact</a> </li>
					<li id="twitter-text"><a href="http://twitter.com/lukencode" >@lukencode</a></li>
					<li>
						<a href="/rss.xml">
							<img src='http://lukencode.com/wp-content/uploads/2011/04/feed-icon.png' />
							Subscribe
						</a>
					</li>
				</ul>
			</aside>
		</div>			
	</div>
				
	<div id="primary">
		<div id="content">
			<div id="post">
	<h1> IP to Geo Location in Asp.Net MVC </h1>
	<div class="date"></div>
	
	<article>
		<p>I have been working on a couple of projects recently (like the new and improved version of <a href="http://gigpig.fm" target="_blank">Gigpig</a> which is coming soon!) which could really benefit from some automagic geolocation lookups for visitors. In the case of Gigpig I wanted to filter what gigs users could see based on where they were in the world.</p>
<p>The database I am using is the binary version of the <a href="http://www.maxmind.com/app/geolitecity" target="_blank">Max Mind GeoLite City</a> free location database. The database essentially maps IP address ranges to cities and countries.  The binary format, I am informed is the fastest version however there is a csv file you can download and import into your database of choice.</p>
<p>Max Mind provide some C# code for querying the binary database but it takes a little work to set up where as I never like doing work someone else has done for me. The library I use is the <a href="http://en.googlemaps.subgurim.net/" target="_blank">GoogleMaps.Subgurim.NET</a> which as well as from google map functions provides code to access the GeoLite City database.</p>
<p>The code to call the Subgurim methods is super simple. Here I am returning the location class which is also included in the library – it has properties for longitude, latitude, country, city and a few other things. All that needs to be passed to it is the location of your database and the ip address you want to look up.</p>
<pre class="prettyprint">public static Location GetLocationFromIP(string ipAddress)
{
    string databasePath = HttpContext.Current.Server.MapPath("~/app_data/geocitylite.dat");
    LookupService service = new LookupService(databasePath);
    Location loc = service.getLocation(ipAddress);

    return loc;
}</pre>
<p>One way I like to use this code in Asp.Net MVC is including some properties in a base controller class that my controllers all inherit so I can access the current location on any controller. One thing to be aware of is the lookup will return null for the ip address 127.0.0.1 so you might want to hard code it for testing.</p>
<pre class="prettyprint">public class ControllerBase : Controller
{
    public string CurrentUserIPAddress
    {
        get
        {
            return HttpContext.Request.UserHostAddress;
        }
    }

    public Location CurrentLocation
    {
        get
        {
            if (Request.Cookies["pref"] == null)
            {
                var loc = LocationHelper.GetLocationFromIP(CurrentUserIPAddress);

                if (loc != null)
                {
                    Response.Cookies["pref"]["city"] = loc.city;
                    Response.Cookies["pref"]["country"] = loc.countryCode;
                    Response.Cookies["pref"]["lat"] = loc.latitude.ToString();
                    Response.Cookies["pref"]["lng"] = loc.longitude.ToString();
                    Response.Cookies["pref"].Expires = DateTime.Now.AddDays(1);
                }

                return loc;
            }
            else
            {
                var loc = new Location
                {
                    city = Request.Cookies["pref"]["city"],
                    countryCode = Request.Cookies["pref"]["country"],
                    latitude = Convert.ToDouble(Request.Cookies["pref"]["lat"]),
                    longitude = Convert.ToDouble(Request.Cookies["pref"]["lng"]),
                };

                return loc;
            }
        }
    }
}</pre>
<p>I also cache the user’s location in a cookie so I can avoid doing a database query for every request. There are a couple of ways you could implement IP address to geo location including some variations of this code – but if you just want something quick and easy this is a good starting point.</p>

	</article>
</div>
	
<div id="page-navigation"> 
	<div class="left">  </div> 
	<div class="right">  </div> 
	<div class="clear">&nbsp;</div>
</div> 


<div id="disqus_thread"></div>

<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'lukencode'; // required: replace example with your forum shortname

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
		</div>				

		<footer>
			<small>powered by <a href="https://github.com/code52/pretzel">pretzel</a> / <a href="https://github.com/mojombo/jekyll">jekyll</a> and living on <a href="https://github.com">github</a></small>
		</footer>
	</div>

</body>
</html>

